---
title: "Homework 5"
author: "Blarry Wang"
date: "1/22/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Loading the Data & Libraries
```{r}
library(gapminder)
library(ggplot2)
library(dplyr)
library(grid)
library(gridExtra)
data(gapminder)
```
### Analysis

#### Model 1: GDP Per Capital v. Life Expectancy 
```{r}
model <- lm(lifeExp ~ gdpPercap, data = gapminder)
outOfSample = c(min(gapminder$gdpPercap), 
            mean(gapminder$gdpPercap), 
            median(gapminder$gdpPercap),
            max(gapminder$gdpPercap))
pred_df <- expand.grid(gdpPercap = outOfSample)
pred <- predict(model, newdata = pred_df, interval = "confidence", level = 0.95)
```

The linear model predicted with 95% confidence that when is shown in the table below:
```{r echo=FALSE} 
pred
```

```{r}
plot1 <- ggplot(bind_cols(pred_df, as.data.frame(pred)), 
                aes(y = outOfSample, x = fit, xmin = lwr, xmax = upr)) +
                geom_point(size = 4.0) +
                geom_errorbarh() +
                labs(y = "GPD Per Capita ($)", 
                     x = "Predicted Life Expectancy",
                     title = "Predicted Life Expectancy wrt GPD Per Capital\n") +
                theme_minimal() +
                theme(plot.title = element_text(size = 10, hjust = 0.5))
plot1
```

As we can see from the graph, when the GPD per capita is $120,000, the life expectancy is more than double of that of the lower GDP per capita counties. But the fact that the predicted age is above 125 highlights that the life expectancy doesn't fit well by a linear model. 


#### Model 2: GDP Per Capital v. Life Expectancy Controlling Population
Now let's control for population in the model. 

```{r}
model <- lm(lifeExp ~ gdpPercap + pop, data = gapminder)
pred_df <- expand.grid(gdpPercap = outOfSample, pop = mean(gapminder$pop))
pred <- predict(model, newdata = pred_df, interval = "confidence", level = 0.95)
```

The dimension of the scenarios is `r dim(pred_df)`. 

The linear model predicted with 95% confidence that when is shown in the table below:

```{r echo=FALSE} 
pred
```

If we plot the fitted values, we can see that controlling for population did not make a significant impact on the model. 

```{r}
plot2 <- ggplot(bind_cols(pred_df, as.data.frame(pred)), 
                aes(y = outOfSample, x = fit, xmin = lwr, xmax = upr)) +
                geom_point(size = 4.0) +
                geom_errorbarh() +
                labs(y = "GPD Per Capita ($)", 
                     x = "Predicted Life Expectancy",
                     title = "Predicted Life Expectancy wrt GPD Per Capital \n& Controlling for Population") +
                theme_minimal() + 
                theme(plot.title = element_text(size = 10, hjust = 0.5))


grid.arrange(plot1, plot2, nrow = 1)
```


#### Model 3: Population v.  Controlling for GDP Per Capital
We will build a slightly different model. 

```{r}
model <- lm(lifeExp ~ pop + gdpPercap, data = gapminder %>% filter(year == 1977))
gdpPercap_pred <- (gapminder %>% filter(year == 1977 & country %in% c("Afghanistan", "Canada", "Japan", "Mexico", "Nepal")))$gdpPercap
populations_pred <- c(max(gapminder$pop), min(gapminder$pop))
pred_df <- expand.grid(pop = populations_pred, gdpPercap = gdpPercap_pred)
pred <- predict(model, newdata = pred_df, interval = "confidence", level = 0.95)
```

The linear model predicted with 95% confidence that when is shown in the table below:
```{r echo=FALSE} 
pred
```

If we plot the fitted values, we can see that in 1977, while contries with larger population tend to have a greater life expectancy, their variance is also a lot larger. There is no meaningful relation we can tell from the graph. 

```{r}
plot3 <- ggplot(bind_cols(pred_df, as.data.frame(pred)), 
                aes(y = pred_df$pop, x = fit, xmin = lwr, xmax = upr)) +
                geom_point(size = 4.0) +
                geom_errorbarh() +
                labs(y = "Population", 
                     x = "Predicted Life Expectancy",
                     title = "Predicted Life Expectancy wrt Population\n& Controlling for GPD Per Capital",
                     caption = "In 1977, while contries with larger population 
                     tend to have a greater life expectancy, their variance is also a lot larger.") +
                theme_minimal() + 
                theme(plot.title = element_text(size = 10, hjust = 0.5))
plot3
```
